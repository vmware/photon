%global build_for %{BUILD_FOR}
%define network_required 1
%global security_hardening none
%define uname_r %{KERNEL_VERSION}-%{KERNEL_RELEASE}
%define _modulesdir /lib/modules/%{uname_r}

# check the release bundle & use the right version, example:
# https://https://github.com/falcosecurity/falco/archive/refs/tags/0.39.2/cmake/modules/falcosecurity-libs.cmake
%define falcosecurity_libs_ver  0.19.0
%define nlohman_json_ver  3.3.0
%define uthash_ver  1.9.8
%define tbb_ver  2022.0.0
%define valijson_ver  1.0.2
%define cpp_httplib_ver  0.15.3
%define cxxopts_ver  3.0.0
%define falcoctl_ver  0.10.1
%define falco_rules_ver  3.2.0

Summary:        The Behavioral Activity Monitor With Container Support
Name:           falco
Version:        0.39.2
Release:        1%{?kernelsubrelease}%{?dist}
License:        GPLv2
URL:            https://falco.org
Group:          Applications/System
Vendor:         VMware, Inc.
Distribution:   Photon

Source0: https://github.com/falcosecurity/falco/archive/refs/tags/%{name}-%{version}.tar.gz
%define sha512 %{name}=198405e9383625ca4d78822de7674c62863d15b3108ba5b06d4cf6ff20850f7eec9123fe7d98d049acc2931b98e4b09d7ef0d66136a31363ce59a64ad9e8eda0

Source1: https://github.com/falcosecurity/libs/archive/falconsecurity-libs-%{falcosecurity_libs_ver}.tar.gz
%define sha512 falconsecurity-libs=5b011c804b07bf2f3eb6a6d7e8c9ef4e54bcc8d74116020e887465aba3dec737bdf8fc854778a8230f7e23e87da29423c6320a8054873eb5c9c957ce40ef3825

Source3: https://github.com/nlohmann/json/archive/nlohman-json-%{nlohman_json_ver}.tar.gz
%define sha512 nlohman-json=cb81e89797a9b8b322a7b421422f919cf1dadc939d83688196664aefc365fa52ec3601ca5419782c99e09e594b56301ac9ea909ac0f5231b70cfa3ff1257a964

Source4: https://github.com/troydhanson/uthash/archive/refs/tags/uthash-%{uthash_ver}.tar.gz
%define sha512 uthash=2ea7f35d662f711e216b1d2d26a1fae698b5f0a71f7151c4747161046de9d8c632dc756cb5948863394694dde47fa6f9383f46ca572c83bb6803383da0f2f740

Source5: https://github.com/oneapi-src/oneTBB/archive/refs/tags/tbb-%{tbb_ver}.tar.gz
%define sha512 tbb=c87b84964b2c323f61895a532968dfa6413a774c177cffbf6e798a07e74e8da5d449144875771df0a1b02657eeb2a7ae4d41c6c432dbf7ea50e3d5a9ea9f8cd3

Source6: https://github.com/tristanpenman/valijson/archive/refs/tags/valijson-%{valijson_ver}.tar.gz
%define sha512 valijson=c1141e533d6a791a01883c5b7ab9501eebc39057a850d784670a4bcf99bff3fee4c3120107128dcaa9db0505adf2ae794700620c02163b3e636f0b635031df80

Source7: https://github.com/yhirose/cpp-httplib/archive/refs/tags/cpp-httplib-%{cpp_httplib_ver}.tar.gz
%define sha512 cpp-httplib=f7fc9c9eb71f091b82958e023a7b417b30d2590fd5d1a920d1c98361f34bcaca796dbeda7f9fdb8b2c722a8968977b77463c6cbb252cba9823a79c22471fa439

Source8: https://github.com/jarro2783/cxxopts/archive/refs/tags/cxxopts-%{cxxopts_ver}.tar.gz
%define sha512 cxxopts=239479a3b35ddef6fc380ac9371e1cf7e3aea066f03e1ea538151fa2fff4296838daa976d55e988d8f87f40c0ae027767bcb214754177499413af1081315565c

Source9: https://github.com/falcosecurity/falcoctl/archive/refs/tags/falcoctl-%{falcoctl_ver}.tar.gz
%define sha512 falcoctl=b55dc0bd53e24897934c72f7f4c524d956c517ec3e754d27664964eaf69b6015f7001214603b0474fc82e7388094c143ad2570f4eed4a8ccbbb30619deba5595

Source10: https://github.com/falcosecurity/rules/archive/refs/tags/falco-rules-%{falco_rules_ver}.tar.gz
%define sha512 falco-rules=b0c02e8bfb4c17b1197fc17adef0eb22557d70eebbb81efb61aaf06f87be3f00d3c517a72c1070d40dbb2f3713c99d8f98afbabf776fb259a6f3be1587da7279

#https://raw.githubusercontent.com/troydhanson/uthash/v1.9.8/src/uthash.h
Source11: uthash.h

Patch1: 0001-Set-local-path-njson.patch
Patch2: 0002-Set-local-path-cpp-httplib.patch
Patch3: 0003-Set-local-path-cxxopts.patch
Patch4: 0004-Set-local-path-rules.patch
Patch5: 0005-Set-local-path-falcoctl.patch

Patch6: 0006-oneAPI-Threading-Building-Block.patch
Patch7: 0007-Local-path-for-Validation-libJSON.patch

BuildArch: x86_64

BuildRequires: cmake
BuildRequires: openssl-devel
BuildRequires: curl-devel
BuildRequires: zlib-devel
BuildRequires: ncurses-devel
BuildRequires: linux-devel = %{uname_r}
BuildRequires: elfutils-devel
BuildRequires: jq-devel
BuildRequires: jsoncpp-devel
BuildRequires: git
BuildRequires: lua-devel
BuildRequires: libyaml-devel
BuildRequires: linux-api-headers
BuildRequires: wget
BuildRequires: which
BuildRequires: grpc-devel
BuildRequires: c-ares-devel
BuildRequires: protobuf-devel
BuildRequires: go
BuildRequires: re2-devel
BuildRequires: yaml-cpp-devel

Requires: linux = %{uname_r}
Requires: zlib
Requires: ncurses
Requires: openssl
Requires: curl
Requires: libyaml
Requires: lua
Requires: sysdig
Requires: dkms
Requires: jsoncpp
Requires: grpc
Requires: jq
Requires: protobuf
Requires: c-ares
Requires: re2
Requires: yaml-cpp

%package    devel
Summary:    falco
Group:      Development/Libraries
Requires:   %{name} = %{version}-%{release}

%description devel
Development files for %{name}

%description
Sysdig %{name} is an open source, behavioral activity monitor designed to detect anomalous activity in your applications.
Falco lets you continuously monitor and detect container, application, host, and network activity; all in one place, from one source of data, with one set of customizable rules.

%prep
%autosetup -a0 -a1 -N

pushd %{_builddir}/%{name}-%{version}
%autopatch -p1 -m1 -M5
popd

pushd %{_builddir}/%{name}-%{version}/libs-%{falcosecurity_libs_ver}
%autopatch -p1 -m6 -M7
popd

%build
sed -i 's/ dns$//g' /etc/nsswitch.conf

export CFLAGS="-Wno-error=misleading-indentation -Wno-dev"

%{cmake} \
    -DCMAKE_BUILD_TYPE=Debug \
    -DUSE_BUNDLED_DEPS:BOOL=OFF \
    -DUSE_BUNDLED_OPENSSL:BOOL=OFF \
    -DUSE_BUNDLED_JQ:BOOL=OFF \
    -DUSE_BUNDLED_YAMLCPP:BOOL=OFF \
    -DBUILD_SHARED_LIBS:BOOL=OFF \
    -DUSE_BUNDLED_LIBELF=OFF \
    -DLIBELF_LIB=%{_libdir}/libelf.so \
    -DCMAKE_INSTALL_LIBDIR=%{_lib} \
    -DCMAKE_INSTALL_SYSCONFDIR=%{_sysconfdir} \
    -DUSE_BUNDLED_UTHASH=OFF \
    -DUTHASH_INCLUDE=%{_builddir}/%libs-%{falcosecurity_libs_ver}/userspace/libscap \
    -DBUILD_DRIVER:BOOL=ON \
    -DDRIVER_SOURCE_DIR="%{_builddir}/%{name}-%{version}/libs-%{falcosecurity_libs_ver}/driver" \
    -DFALCOSECURITY_LIBS_SOURCE_DIR="%{_builddir}/%{name}-%{version}/libs-%{falcosecurity_libs_ver}" \
    -DBUILD_BPF=OFF \
    -DUSE_BUNDLED_JSONCPP=OFF \
    -DUSE_BUNDLED_CXXOPTS=TRUE \
    -DUSE_BUNDLED_NLOHMANN_JSON=TRUE \
    -DUSE_BUNDLED_CPPHTTPLIB=TRUE \
    -DBUILD_LIBSCAP_EXAMPLES=OFF \
    -DBUILD_LIBSCAP_MODERN_BPF=OFF \
    -DBUILD_LIBSINSP_EXAMPLES=OFF  \
    -DUSE_BUNDLED_RE2=OFF \
    -DBUILD_TESTING=OFF

cp %{SOURCE11} libs-%{falcosecurity_libs_ver}/userspace/libscap/
cp %{SOURCE11} %{_arch}-vmware-linux/libscap/
export KERNELDIR="%{_modulesdir}/build"
%{cmake_build}
cp %{_arch}-vmware-linux/falcosecurity-rules-falco-prefix/src/falcosecurity-rules-falco/rules/falco_rules.yaml %{_arch}-vmware-linux/falcosecurity-rules-falco-prefix/src/falcosecurity-rules-falco/
cp -r %{_arch}-vmware-linux/scripts/falcoctl/ %{_arch}-vmware-linux/falcoctl-prefix/src/falcoctl/

%install
export KERNELDIR="%{_modulesdir}/build"
%{cmake_install}
mkdir -p %{buildroot}%{_modulesdir}/extra
install -vm 644 %{__cmake_builddir}/driver/%{name}.ko %{buildroot}%{_modulesdir}/extra
find %{buildroot}%{_modulesdir} -name *.ko -type f -print0 | xargs -0 xz

%clean
rm -rf %{buildroot}/*

%post
/sbin/depmod -a

%postun
/sbin/depmod -a

%files
%defattr(-,root,root)
%{_bindir}/*
%exclude %{_usrsrc}/debug
%exclude %{_libdir}/cmake/
%exclude %{_includedir}/nlohmann/json.hpp
%exclude %{_libdir}/*.a
%{_usrsrc}/%{name}*
%{_includedir}/httplib.h
%{_sysconfdir}/%{name}
%{_datadir}/%{name}
%{_modulesdir}/extra/%{name}.ko.xz
%{_sysconfdir}/falcoctl/falcoctl.yaml

%files devel
%defattr(-,root,root)
%{_libdir}/pkgconfig/*.pc
%{_libdir}/falcosecurity/*
%{_includedir}/falcosecurity/*

%changelog
* Tue Feb 11 2025 Srinidhi Rao <srinidhi.rao@broadcom.com> 0.39.2-1
- Upgrade to version 0.39.2
* Thu Sep 19 2024 Mukul Sikka <mukul.sikka@broadcom.com> 0.36.2-9
- Bump version as a part of go upgrade
* Wed Sep 04 2024 Mukul Sikka <mukul.sikka@broadcom.com> 0.36.2-8
- Add changes to build offline
* Fri Aug 16 2024 Mukul Sikka <mukul.sikka@broadcom.com> 0.36.2-7
- Bump version as a part of grpc upgrade
* Fri Jul 12 2024 Mukul Sikka <mukul.sikka@broadcom.com> 0.36.2-6
- Bump version as a part of go upgrade
* Thu Jun 20 2024 Mukul Sikka <msikka@vmware.com> 0.36.2-5
- Bump version as a part of go upgrade
* Thu Feb 22 2024 Mukul Sikka <msikka@vmware.com> 0.36.2-4
- Bump version as a part of go upgrade
* Tue Jan 09 2024 Ankit Jain <ankitja@vmware.com> 0.36.2-3
- compress .ko and exclude debug from main package
* Thu Dec 14 2023 Piyush Gupta <gpiyush@vmware.com> 0.36.2-2
- Bump up version to compile with new go
* Thu Nov 30 2023 Shreenidhi Shedi <sshedi@vmware.com> 0.36.2-1
- Upgrade to v0.36.2
* Wed Nov 29 2023 Shreenidhi Shedi <sshedi@vmware.com> 0.32.2-12
- Bump version as a part of protobuf upgrade
* Wed Oct 11 2023 Piyush Gupta <gpiyush@vmware.com> 0.32.2-11
- Bump up version to compile with new go
* Mon Sep 18 2023 Piyush Gupta <gpiyush@vmware.com> 0.32.2-10
- Bump up version to compile with new go
* Wed Aug 23 2023 Mukul Sikka <msikka@vmware.com> 0.32.2-9
- Bump version as a part of grpc upgrade
* Mon Jul 31 2023 Mukul Sikka <msikka@vmware.com> 0.32.2-8
- Bump version as a part of grpc upgrade
* Mon Jul 17 2023 Piyush Gupta <gpiyush@vmware.com> 0.32.2-7
- Bump up version to compile with new go
* Wed Jul 05 2023 Brennan Lamoreaux <blamoreaux@vmware.com> 0.32.2-6
- Build Go plugins locally, instead of consuming precompiled binary
* Tue Jun 20 2023 Shreenidhi Shedi <sshedi@vmware.com> 0.32.2-5
- Bump version as a part of lua upgrade
* Sat Jun 17 2023 Shreenidhi Shedi <sshedi@vmware.com> 0.32.2-4
- Bump version as a part of protobuf upgrade
* Thu Jun 01 2023 Nitesh Kumar <kunitesh@vmware.com> 0.32.2-3
- Bump version as a part of ncurses upgrade to v6.4
* Fri Apr 14 2023 Shreenidhi Shedi <sshedi@vmware.com> 0.32.2-2
- Bump version as a part of zlib upgrade
* Thu Sep 15 2022 Vamsi Krishna Brahmajosyula <vbrahmajosyula@vmware.com> 0.32.2-1
- Upgrade to v0.32.2
* Fri Jun 17 2022 Shreenidhi Shedi <sshedi@vmware.com> 0.32.0-1
- Upgrade to v0.32.0
- Introduce devel sub package
* Tue Nov 23 2021 Srivatsa S. Bhat (VMware) <srivatsa@csail.mit.edu> 0.30.0-1
- Update to version 0.30.0.
- Add missing runtime dependency on linux.
* Wed Aug 04 2021 Satya Naga Vasamsetty <svasamsetty@vmware.com> 0.25.0-5
- compile with openssl 3.0.0
* Tue Aug 03 2021 Nitesh Kumar <kunitesh@vmware.com> 0.25.0-4
- Patched for CVE-2021-33505.
* Fri Feb 19 2021 Harinadh D <hdommaraju@vmware.com> 0.25.0-3
- Version bump up to build with latest protobuf
* Tue Sep 29 2020 Satya Naga Vasamsetty <svasamsetty@vmware.com> 0.25.0-2
- openssl 1.1.1
* Wed Sep 16 2020 Bo Gan <ganb@vmware.com> 0.25.0-1
- Updated to 0.25.0
* Mon Sep 14 2020 Ankit Jain <ankitja@vmware.com> 0.15.1-2
- Fix build failure with grpc in patch
* Wed Jun 26 2019 Harinadh Dommaraju <hdommaraju@vmware.com> 0.15.1-1
- Updated to fix CVE-2019-8339
* Wed Dec 12 2018 Sujay G <gsujay@vmware.com> 0.12.1-4
- Disabled bundled JQ, openssl and instead use Photon maintained packages.
* Wed Oct 24 2018 Ajay Kaher <akaher@vmware.com> 0.12.1-3
- Adding BuildArch
* Wed Oct 24 2018 Him Kalyan Bordoloi <bordoloih@vmware.com> 0.12.1-2
- Add depmod for falco-probe.ko and removed patch from new falco-probe-loader
* Mon Sep 24 2018 Srivatsa S. Bhat <srivatsa@csail.mit.edu> 0.12.1-1
- Update falco and sysdig versions to fix build error with linux 4.18
* Tue Jan 02 2018 Alexey Makhalov <amakhalov@vmware.com> 0.8.1-1
- Version update to build against linux-4.14.y kernel
* Thu Aug 24 2017 Rui Gu <ruig@vmware.com> 0.6.0-3
- Disable check section (Bug 1900272).
* Thu May 11 2017 Chang Lee <changlee@vmware.com> 0.6.0-2
- Add falco-probe.ko and change falco-probe.ko path in falco-probe-loader
* Mon Apr 03 2017 Chang Lee <changlee@vmware.com> 0.6.0-1
- Update to version 0.6.0
* Wed Jan 11 2017 Alexey Makhalov <amakhalov@vmware.com> 0.2.0-7
- Fix building for linux-4.9.2
* Mon Dec 19 2016 Xiaolin Li <xiaolinl@vmware.com> 0.2.0-6
- BuildRequires curl-devel
* Thu Dec 15 2016 Alexey Makhalov <amakhalov@vmware.com> 0.2.0-5
- Fix building for linux-4.9
* Wed Nov 30 2016 Alexey Makhalov <amakhalov@vmware.com> 0.2.0-4
- Expand uname -r to have release number
- Exclude /usr/src
* Fri Sep  2 2016 Alexey Makhalov <amakhalov@vmware.com> 0.2.0-3
- Use KERNEL_VERSION macro
* Wed Jul 27 2016 Divya Thaluru <dthaluru@vmware.com> 0.2.0-2
- Removed packaging of debug files
* Tue Jun 28 2016 Harish Udaiya Kumar <hudaiyakumar@vmware.com> 0.2.0-1
- Initial build. First version
