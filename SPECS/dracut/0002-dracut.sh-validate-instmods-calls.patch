From 2045640e11c75bb80374aedd2b7203dd366bae62 Mon Sep 17 00:00:00 2001
From: Shreenidhi Shedi <sshedi@vmware.com>
Date: Wed, 1 Mar 2023 01:29:02 +0530
Subject: [PATCH 2/3] dracut.sh: validate instmods calls

Signed-off-by: Shreenidhi Shedi <sshedi@vmware.com>
---
 dracut.sh                        | 15 ++++++++++++---
 modules.d/01fips/module-setup.sh | 10 ++++++----
 2 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/dracut.sh b/dracut.sh
index af346f3..4ba6953 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -1568,17 +1568,26 @@ if [[ $no_kernel != yes ]]; then
     fi

     if [[ -n "${add_drivers// }" ]]; then
-        hostonly='' instmods -c $add_drivers
+        if ! hostonly='' instmods -c $add_drivers; then
+          dfatal "instmods failed for add_drivers: $add_drivers"
+          exit 1
+        fi
     fi
     if [[ $force_drivers ]]; then
-        hostonly='' instmods -c $force_drivers
+        if ! hostonly='' instmods -c $force_drivers; then
+          dfatal "instmods failed for force_drivers: $force_drivers"
+          exit 1
+        fi
         rm -f $initdir/etc/cmdline.d/20-force_driver.conf
         for mod in $force_drivers; do
             echo "rd.driver.pre=$mod" >>$initdir/etc/cmdline.d/20-force_drivers.conf
         done
     fi
     if [[ $filesystems ]]; then
-        hostonly='' instmods -c $filesystems
+      if ! hostonly='' instmods -c $filesystems; then
+        dfatal "instmods failed for filesystems: $filesystems"
+        exit 1
+      fi
     fi

     dinfo "*** Installing kernel module dependencies ***"
diff --git a/modules.d/01fips/module-setup.sh b/modules.d/01fips/module-setup.sh
index b723dc6..600ea87 100755
--- a/modules.d/01fips/module-setup.sh
+++ b/modules.d/01fips/module-setup.sh
@@ -42,10 +42,12 @@ installkernel() {
     mkdir -m 0755 -p "${initdir}/etc/modprobe.d"

     for _mod in $_fipsmodules; do
-        if hostonly='' instmods -c -s $_mod; then
-            echo $_mod >> "${initdir}/etc/fipsmodules"
-            echo "blacklist $_mod" >> "${initdir}/etc/modprobe.d/fips.conf"
-        fi
+      if ! hostonly='' instmods -c -s "$_mod"; then
+        dfatal "ERROR: instmods -c -s $_mod failed"
+        exit 1
+      fi
+      echo "$_mod" >> "${initdir}/etc/fipsmodules"
+      echo "blacklist $_mod" >> "${initdir}/etc/modprobe.d/fips.conf"
     done

     # with hostonly_default_device fs module for /boot is not installed by default
--
2.25.1
