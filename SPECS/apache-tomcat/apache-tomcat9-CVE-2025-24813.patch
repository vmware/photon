From eb61aade8f8daccaecabf07d428b877975622f72 Mon Sep 17 00:00:00 2001
From: remm <remm@apache.org>
Date: Fri, 24 Jan 2025 15:06:02 +0100
Subject: [PATCH] Enhance lifecycle of temporary files used by partial PUT

Delete temporary file right after finishing request processing.
Simplify using createTempFile.
---
 .../catalina/servlets/DefaultServlet.java       | 17 +++++++----------
 webapps/docs/changelog.xml                      |  3 +++
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/java/org/apache/catalina/servlets/DefaultServlet.java b/java/org/apache/catalina/servlets/DefaultServlet.java
index 34b6f4379ecf..0886155e3a41 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -625,7 +625,7 @@ protected void doPut(HttpServletRequest req, HttpServletResponse resp) throws Se
         }
 
         InputStream resourceInputStream = null;
-
+        File tempContentFile = null;
         try {
             // Append data specified in ranges to existing content for this
             // resource - create a temp. file on the local filesystem to
@@ -634,8 +634,8 @@ protected void doPut(HttpServletRequest req, HttpServletResponse resp) throws Se
             if (range == IGNORE) {
                 resourceInputStream = req.getInputStream();
             } else {
-                File contentFile = executePartialPut(req, range, path);
-                resourceInputStream = new FileInputStream(contentFile);
+                tempContentFile = executePartialPut(req, range, path);
+                resourceInputStream = new FileInputStream(tempContentFile);
             }
 
             if (resources.write(path, resourceInputStream, true)) {
@@ -659,6 +659,9 @@ protected void doPut(HttpServletRequest req, HttpServletResponse resp) throws Se
                     // Ignore
                 }
             }
+            if (tempContentFile != null) {
+                tempContentFile.delete();
+            }
         }
     }
 
@@ -681,13 +684,7 @@ protected File executePartialPut(HttpServletRequest req, Range range, String pat
         // resource - create a temp. file on the local filesystem to
         // perform this operation
         File tempDir = (File) getServletContext().getAttribute(ServletContext.TEMPDIR);
-        // Convert all '/' characters to '.' in resourcePath
-        String convertedResourcePath = path.replace('/', '.');
-        File contentFile = new File(tempDir, convertedResourcePath);
-        if (contentFile.createNewFile()) {
-            // Clean up contentFile when Tomcat is terminated
-            contentFile.deleteOnExit();
-        }
+        File contentFile = File.createTempFile("put-part-", null, tempDir);
 
         try (RandomAccessFile randAccessContentFile = new RandomAccessFile(contentFile, "rw")) {
 
#diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
#index cf2fa86bfcfa..84fbc23e0136 100644
#--- a/webapps/docs/changelog.xml
#+++ b/webapps/docs/changelog.xml
#@@ -181,6 +181,9 @@
#         <code>IOException</code> occurs on a non-container thread during
#         asynchronous processing. (markt)
#       </fix>
#+      <fix>
#+        Enhance lifecycle of temporary files used by partial PUT. (remm)
#+      </fix>
#     </changelog>
#   </subsection>
#   <subsection name="Coyote">
