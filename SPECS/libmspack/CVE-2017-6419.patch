From a83773682e856ad6529ba6db8d1792e6d515d7f1 Mon Sep 17 00:00:00 2001
From: Mickey Sola <msola@sourcefire.com>
Date: Wed, 29 Mar 2017 14:55:26 -0400
Subject: [PATCH] fixing potential OOB window write when unpacking chm files

---
 libmspack-0.10.1alpha/mspack/lzxd.c | 11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff -ruN a/mspack/lzxd.c b/mspack/lzxd.c
--- a/mspack/lzxd.c	2018-11-05 11:53:09.000000000 +0000
+++ b/mspack/lzxd.c	2023-03-31 05:48:27.582788365 +0000
@@ -776,8 +776,13 @@
       case LZX_BLOCKTYPE_UNCOMPRESSED:
         /* as this_run is limited not to wrap a frame, this also means it
          * won't wrap the window (as the window is a multiple of 32k) */
+        if (window_posn + this_run > lzx->window_size) {
+                D(("match ran over window boundary"))
+                return lzx->error = MSPACK_ERR_DECRUNCH;
+        }
         rundest = &window[window_posn];
         window_posn += this_run;
+        
         while (this_run > 0) {
           if ((i = i_end - i_ptr) == 0) {
             READ_IF_NEEDED;
@@ -898,8 +903,10 @@
   struct mspack_system *sys;
   if (lzx) {
     sys = lzx->sys;
-    sys->free(lzx->inbuf);
-    sys->free(lzx->window);
+    if(lzx->inbuf)
+        sys->free(lzx->inbuf);
+    if(lzx->window)
+        sys->free(lzx->window);
     sys->free(lzx);
   }
 }
