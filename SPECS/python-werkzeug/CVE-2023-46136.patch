From: =?utf-8?q?Pawe=C5=82_Srokosz?= <pawel.srokosz@cert.pl>
Date: Thu, 12 Oct 2023 18:50:04 +0200
Subject: Fix: slow multipart parsing for huge files with few CR/LF characters

(cherry picked from commit b1916c0c083e0be1c9d887ee2f3d696922bfc5c1)
---
 src/werkzeug/sansio/multipart.py | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/werkzeug/sansio/multipart.py b/src/werkzeug/sansio/multipart.py
index 2684e5d..2c0947d 100644
--- a/src/werkzeug/sansio/multipart.py
+++ b/src/werkzeug/sansio/multipart.py
@@ -206,12 +206,20 @@ class MultipartDecoder:
                 self._search_position = max(0, len(self.buffer) - SEARCH_EXTRA_LENGTH)
 
         elif self.state == State.DATA:
-            if self.buffer.find(b"--" + self.boundary) == -1:
+            boundary = b"--" + self.boundary
+
+            if self.buffer.find(boundary) == -1:
                 # No complete boundary in the buffer, but there may be
                 # a partial boundary at the end. As the boundary
                 # starts with either a nl or cr find the earliest and
                 # return up to that as data.
                 data_length = del_index = self.last_newline()
+                # If amount of data after last newline is far from
+                # possible length of partial boundary, we should
+                # assume that there is no partial boundary in the buffer
+                # and return all pending data.
+                if (len(self.buffer) - data_length) > len(b"\n" + boundary):
+                    data_length = del_index = len(self.buffer)
                 more_data = True
             else:
                 match = self.boundary_re.search(self.buffer)
