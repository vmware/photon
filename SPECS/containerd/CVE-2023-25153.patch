From 84936fd1f6a0670ab8c7665cb87fae6b87b0b908 Mon Sep 17 00:00:00 2001
From: Samuel Karp <samuelkarp@google.com>
Date: Thu, 12 Jan 2023 18:06:41 -0800
Subject: [PATCH] importer: stream oci-layout and manifest.json

Signed-off-by: Samuel Karp <samuelkarp@google.com>
(cherry picked from commit 9e4acc02807a012a51f68afef41f189a350a16cd)
Signed-off-by: Samuel Karp <samuelkarp@google.com>
---
 images/archive/importer.go | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/images/archive/importer.go b/images/archive/importer.go
index 2b9fa4da221..c1c802fb55c 100644
--- a/images/archive/importer.go
+++ b/images/archive/importer.go
@@ -232,12 +232,14 @@ func ImportIndex(ctx context.Context, store content.Store, reader io.Reader, opt
 	return writeManifest(ctx, store, idx, ocispec.MediaTypeImageIndex)
 }
 
+const (
+	kib       = 1024
+	mib       = 1024 * kib
+	jsonLimit = 20 * mib
+)
+
 func onUntarJSON(r io.Reader, j interface{}) error {
-	b, err := io.ReadAll(r)
-	if err != nil {
-		return err
-	}
-	return json.Unmarshal(b, j)
+	return json.NewDecoder(io.LimitReader(r, jsonLimit)).Decode(j)
 }
 
 func onUntarBlob(ctx context.Context, r io.Reader, store content.Ingester, size int64, ref string) (digest.Digest, error) {
