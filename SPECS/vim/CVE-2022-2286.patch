From f12129f1714f7d2301935bb21d896609bdac221c Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 1 Jul 2022 19:58:30 +0100
Subject: [PATCH] patch 9.0.0020: with some completion reading past end of
 string

Problem:    With some completion reading past end of string.
Solution:   Check the length of the string.

[ssrish: resolved a hunk failure]
Signed-off-by: Srish Srinivasan <ssrish@vmware.com>
---
 src/insexpand.c                   | 14 ++++++++++++--
 src/testdir/test_ins_complete.vim |  8 ++++++++
 src/version.c                     |  2 ++
 3 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/src/insexpand.c b/src/insexpand.c
index 26beb21..baebaa6 100644
--- a/src/insexpand.c
+++ b/src/insexpand.c
@@ -2247,11 +2247,21 @@ ins_compl_stop(int c, int prev_mode, int retval)
     // but only do this, if the Popup is still visible
     if (c == Ctrl_E)
     {
+	char_u *p = NULL;
+
 	ins_compl_delete();
 	if (compl_leader != NULL)
-	    ins_bytes(compl_leader + get_compl_len());
+	    p = compl_leader;
 	else if (compl_first_match != NULL)
-	    ins_bytes(compl_orig_text + get_compl_len());
+	    p = compl_orig_text;
+	if (p != NULL)
+	{
+	    int	    compl_len = get_compl_len();
+	    int	    len = (int)STRLEN(p);
+
+	    if (len > compl_len)
+		ins_bytes_len(p + compl_len, len - compl_len);
+	}
 	retval = TRUE;
     }
 
diff --git a/src/testdir/test_ins_complete.vim b/src/testdir/test_ins_complete.vim
index 2b57a20..2578d24 100644
--- a/src/testdir/test_ins_complete.vim
+++ b/src/testdir/test_ins_complete.vim
@@ -2122,4 +2122,12 @@ func Test_tagfunc_wipes_out_buffer()
 endfunc
 
 
+func Test_complete_overrun()
+  " this was going past the end of the copied text
+  new
+  sil norm siÂ”0s0
+  bwipe!
+endfunc
+
+
 " vim: shiftwidth=2 sts=2 expandtab
diff --git a/src/version.c b/src/version.c
index e3e385b..6c982cd 100644
--- a/src/version.c
+++ b/src/version.c
@@ -735,6 +735,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    20,
 /**/
     579,
 /**/
-- 
2.35.6

