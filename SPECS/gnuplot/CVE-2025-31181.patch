From af96c2c1b20383684b1ec2084dab7936f7053031 Mon Sep 17 00:00:00 2001
From: Ethan A Merritt <merritt@u.washington.edu>
Date: Tue, 14 Jan 2025 20:56:37 -0800
Subject: [PATCH] x11: protect against double fclose() if two errors in a row

Bug 2753
---
 term/x11.trm | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/term/x11.trm b/term/x11.trm
index 18ad4ad85..cbe01dd0e 100644
--- a/term/x11.trm
+++ b/term/x11.trm
@@ -854,8 +854,9 @@ X11_atexit()
 	/* dont wait(), since they might be -persist */
 	X11_ipc = NULL;
 #ifdef PIPE_IPC
-	close(ipc_back_fd);
-	ipc_back_fd = -1;
+	if (ipc_back_fd >= 0)
+	    close(ipc_back_fd);
+	ipc_back_fd = IPC_BACK_CLOSED;
 #endif
     }
 }
@@ -1374,7 +1375,8 @@ X11_graphics()
 #ifdef PIPE_IPC
     /* if we know the outboard driver has stopped, restart it */
     if (ipc_back_fd == IPC_BACK_CLOSED) {
-	fclose(X11_ipc);
+	if (X11_ipc > 0)
+	    fclose(X11_ipc);
 	X11_ipc = NULL;
 	X11_init();
     }
-- 
2.40.0

