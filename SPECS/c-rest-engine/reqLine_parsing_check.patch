From 36f7b88cfedf404ff8ef02ed2e2092ca963cb384 Mon Sep 17 00:00:00 2001
From: Kumar Kaushik <kaushikk@vmware.com>
Date: Tue, 30 Jan 2018 18:30:46 -0800
Subject: [PATCH] Improper request line parsing check

Change-Id: I606bfd18efe8fe9cd4d9cf7533e4991e81c74ae2
---
 server/restengine/httpProtocolHead.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/server/restengine/httpProtocolHead.c b/server/restengine/httpProtocolHead.c
index 95089a3..a7ca54a 100644
--- a/server/restengine/httpProtocolHead.c
+++ b/server/restengine/httpProtocolHead.c
@@ -1001,7 +1001,7 @@ VmRESTProcessRequestLine(
         {
             /**** 1. Parsing HTTP METHOD ****/
             pszFirstSpace = strchr(pszStartNewLine, ' ');
-            if (pszFirstSpace != NULL && ((pszFirstSpace - pszStartNewLine) <= MAX_METHOD_LEN))
+            if (pszFirstSpace != NULL && ((pszFirstSpace - pszStartNewLine) <= MAX_METHOD_LEN) && ((pszFirstSpace - pszStartNewLine) > 0))
             {
                 strncpy(pRequest->requestLine->method, pszStartNewLine, (pszFirstSpace - pszStartNewLine));
                 pRequest->requestLine->method[pszFirstSpace - pszStartNewLine] = '\0';
@@ -1016,13 +1016,13 @@ VmRESTProcessRequestLine(
                 /**** 2. Parse HTTP URI****/
                 pszSecondSpace = strchr((pszFirstSpace + 1), ' ');
              
-                if (pszSecondSpace != NULL && ((pszSecondSpace - pszFirstSpace) < MAX_URI_LEN))
+                if (pszSecondSpace != NULL && ((pszSecondSpace - pszFirstSpace) < MAX_URI_LEN) && ((pszSecondSpace - pszFirstSpace) > 0))
                 {
                     strncpy(pRequest->requestLine->uri, (pszFirstSpace + 1), (pszSecondSpace - pszFirstSpace - 1));
                     pRequest->requestLine->uri[pszSecondSpace - pszFirstSpace - 1] = '\0';
 
                     /**** 3. Parse HTTP Version ****/
-                    if ((pszEndNewLine - pszSecondSpace - 1) <= HTTP_VER_LEN)
+                    if (((pszEndNewLine - pszSecondSpace - 1) <= HTTP_VER_LEN) && ((pszEndNewLine - pszSecondSpace - 1) > 0))
                     {
                         strncpy(pRequest->requestLine->version, (pszSecondSpace + 1), (pszEndNewLine - pszSecondSpace - 1));
                         pRequest->requestLine->version[pszEndNewLine - pszSecondSpace - 1] = '\0';
@@ -1198,10 +1198,16 @@ VmRESTProcessHeaders(
             BAIL_ON_VMREST_ERROR(dwError);
         }
     }
-    else     /**** pszEndNewLine = NULL  ****/
+    else if (nBytes < MAX_REQ_LIN_LEN)    /**** pszEndNewLine = NULL  ****/
     {
         VMREST_LOG_DEBUG(pRESTHandle,"Incomplete line processing.. wait for IO.., bytesProcessed %u, nBytes %u", bytesProcessed, nBytes);
     }
+    else
+    {
+        dwError = BAD_REQUEST;
+        BAIL_ON_VMREST_ERROR(dwError);
+    }
+    
 
 cleanup:
 
