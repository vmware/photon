From e6ff33ca50c1180725dde11c84ee93fcdb4235ef Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Mon, 18 Sep 2017 13:05:25 -0700
Subject: [PATCH] Check error return from bfd_canonicalize_dynamic_reloc

Since bfd_canonicalize_dynamic_reloc returns -1 on error, check it in
elf_i386_get_synthetic_symtab and elf_x86_64_get_synthetic_symtab.

	PR ld/22148
	* elf32-i386.c (elf_i386_get_synthetic_symtab): Check error
	return from bfd_canonicalize_dynamic_reloc.
	* elf64-x86-64.c (elf_x86_64_get_synthetic_symtab): Likewise.

(cherry picked from commit 94670f6cf11fc29cc6db6814b38c4305d9bcac96)
---
 bfd/elf32-i386.c   | 2 ++
 bfd/elf64-x86-64.c | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/bfd/elf32-i386.c b/bfd/elf32-i386.c
index 00a6397..5c1c3ff 100644
--- a/bfd/elf32-i386.c
+++ b/bfd/elf32-i386.c
@@ -6342,6 +6342,8 @@ elf_i386_get_synthetic_symtab (bfd *abfd,
 
   dynrelcount = bfd_canonicalize_dynamic_reloc (abfd, dynrelbuf,
 						dynsyms);
+  if (dynrelcount < 0)
+    return -1;
 
   /* Sort the relocs by address.  */
   qsort (dynrelbuf, dynrelcount, sizeof (arelent *), compare_relocs);
diff --git a/bfd/elf64-x86-64.c b/bfd/elf64-x86-64.c
index 6bc1898..80dd791 100644
--- a/bfd/elf64-x86-64.c
+++ b/bfd/elf64-x86-64.c
@@ -6717,6 +6717,8 @@ elf_x86_64_get_synthetic_symtab (bfd *abfd,
 
   dynrelcount = bfd_canonicalize_dynamic_reloc (abfd, dynrelbuf,
 						dynsyms);
+  if (dynrelcount < 0)
+    return -1;
 
   /* Sort the relocs by address.  */
   qsort (dynrelbuf, dynrelcount, sizeof (arelent *), compare_relocs);
