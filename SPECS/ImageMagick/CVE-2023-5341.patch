From aa673b2e4defc7cad5bec16c4fc8324f71e531f1 Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Sun, 24 Sep 2023 07:28:19 -0400
Subject: [PATCH] check for BMP file size, poc provided by Hardik Shah of
 Vehere (Dawn Treaders team)

---
 coders/bmp.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/coders/bmp.c b/coders/bmp.c
index 8ff76bb..bb9ce2f 100644
--- a/coders/bmp.c
+++ b/coders/bmp.c
@@ -629,6 +629,9 @@ static Image *ReadBMPImage(const ImageInfo *image_info,ExceptionInfo *exception)
         "  BMP header size: %u",bmp_info.size);
     if (bmp_info.size > 124)
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
+    if ((bmp_info.file_size != 0) &&
+        ((MagickSizeType) bmp_info.file_size > GetBlobSize(image)))
+      ThrowReaderException(CorruptImageError,"ImproperImageHeader");
     if (bmp_info.offset_bits < bmp_info.size)
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
     bmp_info.offset_bits=MagickMax(14+bmp_info.size,bmp_info.offset_bits);
--
2.39.0

